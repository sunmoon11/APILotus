jQuery( document ).ready(function( $ ) 
{
    var stripe = Stripe('pk_test_kyxgtxD5BcPyVARUJbiRgQCN');
    //var stripe = Stripe('pk_live_y00zEB5AHQZO1u9ln9Sv3Kdg');
    var elements = stripe.elements();
    
    var cardNumber;
    var cardExpiry;
    var cardCvc;

    var warn_userid_invalid = 'Please use only letters (a-z), numbers';
    var warn_email_invalid = 'Please use only letters (a-z), numbers, and periods, underline.';
    var warn_nomatch = 'These passwords don\'t match. Try again?';

    var user_id = '';
    var email = '';
    var password = '';
    var sub_domain = '';

    var card_init = true;

	
	init();


	function init()
	{
		$('#input_user_id').focus();

        var style = {
            base: {
                color: '#303238',
                fontSize: '15px',
                lineHeight: '34px',
                fontSmoothing: 'antialiased',
                '::placeholder': {
                    color: '#d9d9d9',
                },
            },
            invalid: {
                color: '#e5424d',
                ':focus': {
                    color: '#303238',
                },
            },
        };

        cardNumber = elements.create('cardNumber', {style: style});
        cardExpiry = elements.create('cardExpiry', {style: style});
        cardCvc = elements.create('cardCvc', {style: style});

        cardNumber.mount('#card_number');
        cardExpiry.mount('#card_expiry');
        cardCvc.mount('#card_cvc');
	}

    // Lose focus of User ID input
    $('#input_user_id').focusout(function ()
    {
        user_id = $('#input_user_id').val();

        if (user_id == '')
        {
            $('#warning_user_id').html('You can\'t leave this empty.');
        }
        else
        {
            $('#warning_user_id').html('Checking user id valid ...');

            $.ajax(
            {
                type : 'GET',
                url : './daemon/ajax_landingpage/signup_check_userid.php',
                data : {
                    'user_id' : user_id
                },
                success:function(response)
                {
                    var obj = jQuery.parseJSON(response);
                    
                    if (obj[1])
                        $('#warning_user_id').html('That user id is taken. Try another.');
                    else
                        $('#warning_user_id').html('');
                },
                failure:function(response) 
                {
                    $('#warning_user_id').html('Checking user id error!');
                }
            });
        }
    });

    // Lose focus of Email Address input
    $('#input_email').focusout(function ()
    {
        email = $('#input_email').val();

        if ($('#input_email').val() == '')
        {
            $('#warning_email').html('You can\'t leave this empty.');
        }
        else
        {
            $('#warning_email').html('Checking email valid ...');

            $.ajax(
            {
                type : 'GET',
                url : './daemon/ajax_landingpage/signup_check_email.php',
                data : {
                    'email' : $('#input_email').val()
                },
                success:function(response)
                {
                    var obj = jQuery.parseJSON(response);
                    
                    if (obj[1])
                        $('#warning_email').html('That email is taken. Try another.');
                    else
                        $('#warning_email').html('');
                },
                failure:function(response) 
                {
                    $('#warning_email').html('Checking email error!');
                }
            });
        }
    });

    // Lose focus of Password input
    $('#input_password').focusout(function ()
    {
        password = $('#input_password').val();

        if ($('#input_password').val() == '')
        {
            $('#warning_password').html('You can\'t leave this empty.');
        }
        else
        {
            if ($('#input_password').val() != $('#input_repassword').val())
            {
                if ($('#input_repassword').val() == '')
                    $('#warning_password').html('Please type password again.');
                else
                    $('#warning_password').html('These passwords don\'t match. Try again?');
            }
            else
            {
                $('#warning_password').html('');
                $('#warning_repassword').html('');
            }
        }
    });

    // Lose focus of Re-type Password input
    $('#input_repassword').focusout(function ()
    {
        if ($('#input_repassword').val() == '')
        {
            $('#warning_repassword').html('You can\'t leave this empty.');
        }
        else
        {
            if ($('#input_password').val() != $('#input_repassword').val())
            {
                $('#warning_repassword').html('These passwords don\'t match. Try again?');
            }
            else
            {
                $('#warning_password').html('');
                $('#warning_repassword').html('');
            }
        }
    });

    // Lose focus of First Name input
    $('#input_first_name').focusout(function ()
    {
        if ($('#input_first_name').val() == '')
            $('#warning_first_name').html('You can\'t leave this empty.');
        else
            $('#warning_first_name').html('');
    });

    // Lose focus of Last Name input
    $('#input_last_name').focusout(function ()
    {
        if ($('#input_last_name').val() == '')
            $('#warning_last_name').html('You can\'t leave this empty.');
        else
            $('#warning_last_name').html('');
    });

    // Lose focus of Sub-domain input
    $('#input_sub_domain').focusout(function ()
    {
        sub_domain = $('#input_sub_domain').val();

        if (sub_domain == '')
        {
            $('#warning_sub_domain').html('You can\'t leave this empty.');
        }
        else
        {
            $('#warning_sub_domain').html('Checking user id valid ...');

            $.ajax(
            {
                type : 'GET',
                url : './daemon/ajax_landingpage/signup_check_subdomain.php',
                data : {
                    'sub_domain' : sub_domain
                },
                success:function(response)
                {
                    var obj = jQuery.parseJSON(response);
                    
                    if (obj[1])
                        $('#warning_sub_domain').html('That sub-domain is taken. Try another.');
                    else
                        $('#warning_sub_domain').html('');
                },
                failure:function(response) 
                {
                    $('#warning_sub_domain').html('Checking sub-domain error!');
                }
            });
        }
    });

    // Change event of Credit Card Number input
    cardNumber.addEventListener('change', function(event) 
    {
        card_init = false;

        if (event.empty == true)
        {
            $('#warning_card_number').html('You can\'t leave this empty.');
            return;
        }

        if (event.error) 
            $('#warning_card_number').html(event.error.message);
        else
            $('#warning_card_number').html('');
    });

    // Change event of Expiry Date input
    cardExpiry.addEventListener('change', function(event) 
    {
        card_init = false;

        if (event.empty == true)
        {
            $('#warning_expiry_date').html('You can\'t leave this empty.');
            return;
        }

        if (event.error) 
            $('#warning_expiry_date').html(event.error.message);
        else
            $('#warning_expiry_date').html('');
    });

    // Change event of CVC Number input
    cardCvc.addEventListener('change', function(event) 
    {
        card_init = false;

        if (event.empty == true)
        {
            $('#warning_cvc_number').html('You can\'t leave this empty.');
            return;
        }

        if (event.error) 
            $('#warning_cvc_number').html(event.error.message);
        else
            $('#warning_cvc_number').html('');
    });

    // Click Verify Email Button
    $('#verify_email_btn').click(function ()
    {
        if ($('#warning_user_id').html() == '' && $('#warning_email').html() == '' && $('#warning_password').html() == '' && $('#warning_repassword').html() == '')
        {
            if (grecaptcha.getResponse() == '')
            {
                alert('Please check I\'m not a robot.');
                return;
            }

            $('#waiting_modal').modal('show');

            $.ajax(
            {
                type : 'GET',
                url : './daemon/ajax_landingpage/signup_account_add.php',
                data : {
                    'user_id' : $('#input_user_id').val(), 
                    'email' : $('#input_email').val(), 
                    'password' : $('#input_password').val()
                },
                success:function(response)
                {
                    $('#waiting_modal').modal('hide');

                    var obj = jQuery.parseJSON(response);
                    
                    if (obj[0] == 'success')
                    {
                        $('#input_verify_code').focus();
                        $('#verify_email_content').slideDown('1000');

                        ajaxSendEmail($('#input_email').val(), obj[1]);
                    }
                    else
                    {
                        alert('Account Error!');
                    }
                },
                failure:function(response) 
                {
                    $('#waiting_modal').modal('hide');
                    alert('Account Error!');
                }
            });
        }
    });

    // Click Next Step1 Button
    $('#next_step1_btn').click(function ()
    {
        if ($('#input_verify_code').val() == '')
        {
            $('#warning_verify_code').html('You can\'t leave this empty.');
            $('#input_verify_code').focus();
            return;
        }

        $('#waiting_modal').modal('show');

        $.ajax(
        {
            type : 'GET',
            url : './daemon/ajax_landingpage/signup_verifycode_get.php',
            data : {
                'user_id' : $('#input_user_id').val()
            },
            success:function(response)
            {
                $('#waiting_modal').modal('hide');

                var obj = jQuery.parseJSON(response);
                    
                if (obj[0] == 'success')
                {
                    if (obj[1] == $('#input_verify_code').val())
                    {
                        ajaxAccountVerified(user_id);
                    }
                    else
                        alert('Verification code doesn\'t match!');
                }
                else
                {
                    alert('Account Verification Error!');
                }
            },
            failure:function(response) 
            {
                $('#waiting_modal').modal('hide');
                alert('Account Verification Error!');
            }
        });
    });

    // Click Next Step2 Button
    $('#next_step2_btn').click(function ()
    {
        if ($('#warning_first_name').html() == '' && $('#warning_last_name').html() == '' && $('#warning_sub_domain').html() == '')
        {
            $('#waiting_modal').modal('show');

            $.ajax(
            {
                type : 'GET',
                url : './daemon/ajax_landingpage/signup_account_update.php',
                data : {
                    'user_id' : user_id, 
                    'first_name' : $('#input_first_name').val(), 
                    'last_name' : $('#input_last_name').val(),
                    'display_name' : $('#input_display_name').val(), 
                    'sub_domain' : $('#input_sub_domain').val(),
                    'sms_number' : $('#input_sms_number').val(), 
                    'bot_id' : $('#input_bot_id').val()
                },
                success:function(response)
                {
                    $('#waiting_modal').modal('hide');

                    if (response == 'success')
                    {
                        //$('#input_verify_code').focus();

                        $('#step2_content').slideUp('1000', function() 
                        {
                            $('#step2_btn').removeClass('active').addClass('complete');
                            $('#step2_arrow').addClass('complete');
                            $('#step3_btn').addClass('active');

                            $('#step3_content').slideDown('1000');
                        });
                    }
                    else
                    {
                        alert('Personal Error!');
                    }
                },
                failure:function(response) 
                {
                    $('#waiting_modal').modal('hide');
                    alert('Personal Error!');
                }
            });
        }
    });

    // Click Next Step3 Button
    $('#next_step3_btn').click(function ()
    {
        if (card_init)
        {
            $('#warning_card_number').html('You can\'t leave this empty.');
            $('#warning_expiry_date').html('You can\'t leave this empty.');
            $('#warning_cvc_number').html('You can\'t leave this empty.');

            return;
        }

        if ($('#warning_card_number').html() == '' && $('#warning_expiry_date').html() == '' && $('#warning_cvc_number').html() == '')
        {
            $('#waiting_modal').modal('show');

            stripe.createToken(cardNumber).then(function(result) 
            {
                if (result.token)
                {
                    $.ajax(
                    {
                        type : 'GET',
                        url : './daemon/ajax_landingpage/signup_card_add.php',
                        data : {
                            'user_id' : user_id, 
                            'sub_domain' : sub_domain,
                            'email' : email,
                            'token_id' : result.token.id,
                            'card_id' : result.token.card.id
                        },
                        success:function(response)
                        {
                            $('#waiting_modal').modal('hide');

                            if (response == 'success')
                            {
                                $('#step3_content').slideUp('1000', function() 
                                {
                                    $('#confirm_user_id').val(user_id);
                                    $('#confirm_password').val(password);
                                    $('#confirm_domain_url').val('https://' + sub_domain + '.apilotus.com');

                                    $('#step3_btn').removeClass('active').addClass('complete');
                                    $('#step3_arrow').addClass('complete');
                                    $('#step4_btn').addClass('active');

                                    $('#step4_content').slideDown('1000');
                                });
                            }
                            else
                            {
                                alert('Card Subscription Error!');
                            }
                        },
                        failure:function(response) 
                        {
                            $('#waiting_modal').modal('hide');
                            alert('Card Subscription Error!');
                        }
                    });
                }
                else
                    $('#waiting_modal').modal('hide');
            });
        }
    });

    // Click Next Go to my domain Button
    $('#next_step4_btn').click(function ()
    {
        window.location.href = 'https://' + sub_domain + '.apilotus.com';
    });

    function ajaxAccountVerified(uID) 
    {
        $.ajax(
        {
            type : 'GET',
            url : './daemon/ajax_landingpage/signup_account_verified.php',
            data : {
                'user_id' : uID
            },
            success:function(response)
            {
                if (response == 'success')
                {
                    $('#input_first_name').focus();

                    $('#step1_content').slideUp('1000', function() 
                    {
                        $('#step1_btn').removeClass('active').addClass('complete');
                        $('#step1_arrow').addClass('complete');
                        $('#step2_btn').addClass('active');

                        $('#step2_content').slideDown('1000');
                    });
                }
                else
                    alert('Account Verification Error!');
            },
            failure:function(response) 
            {
                alert('Account Verification Error!');
            }
        });
    }

    function ajaxSendEmail(email, verify_code) 
    {
        $.ajax(
        {
            type : 'GET',
            url : './daemon/ajax_landingpage/signup_send_email.php',
            data : {
                'email' : email,
                'verify_code' : verify_code
            },
            success:function(response)
            {
            },
            failure:function(response) 
            {
            }
        });
    }

});