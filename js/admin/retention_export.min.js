jQuery(document).ready(function(t){function e(e){t(".retention_alert").html(e),t(".retention_alert").fadeIn(1e3,function(){t(".retention_alert").fadeOut(3e3)})}function a(e){e?t(".retention_waiting").html(_):t(".retention_waiting").html("")}function n(){""!=t("#from_date").val()?""!=t("#to_date").val()?(a(!0),b=(new Date).getTime(),t.ajax({type:"GET",url:"../daemon/ajax_admin/crm_list.php",data:{},success:function(n){if(a(!1),"error"!=n)if("no_cookie"!=n){var o=(c=jQuery.parseJSON(n)).length,r="",l='<li><a href="#Top"><b>Back to top</b></a></li>';if(o>0){for(d=0;d<o;d++)r+='<section id="section_'+c[d][0]+'" class="group">',r+='<table class="table table-hover" style="border-right: 1px solid #dadada">',r+="<thead>",r+="<tr>",r+='<th style="width:100px;">CRM #</th>',r+='<th style="width:200px;">CRM Name</th>',r+='<th style="width:150px;">Campaign #</th>',r+="<th>Campaign ID (Name)</th>",r+='<th style="width:200px;">Affiliate Count</th>',r+='<th style="width:100px;">Status</th>',r+='<th style="width:100px;"><button id="refcrm_'+c[d][0]+'" type="button" class="btn btn-link btn-sm btn_refresh btn_refresh_crm" id=""><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></th>',r+="</tr>",r+="</thead>",r+='<tbody id="tbody_'+c[d][0]+'">',r+="<tr>",r+="<td>"+(d+1)+"</td>",r+="<td>"+c[d][1]+"</td>",r+='<td id="crmwait_'+c[d][0]+'">'+_+"</td>",r+='<td colspan="4"></td>',r+="</tr>",r+="</tbody>",r+="</table>",r+="</section>",l+='<li><a href="#section_'+c[d][0]+'">'+c[d][1]+"</a></li>";t(".export_content").html(r),t(".crm_sidebar").html(l),t(".crm_sidebar").show();for(var d=0;d<o;d++)i(c[d][0],d+1,c[d][1],"0")}else e("There is no any crm site information.")}else window.location.href="../../admin/login.php";else e("Cannot load CRM site information.")},failure:function(t){a(!1),e("Cannot load CRM site information.")}})):e("Please select TO DATE."):e("Please select FROM DATE.")}function i(n,i,r,l){t.ajax({type:"GET",url:"../daemon/ajax_admin/export_retention_campaign.php",data:{user_token:b,crm_id:n,from_date:t("#from_date").val(),to_date:t("#to_date").val(),cycle:g,delete:l},success:function(a){var n=jQuery.parseJSON(a);if("error"==n[0])t("#crmwait_"+n[2]).html(h),e("Cannot load retention information.");else{if("no_cookie"==n[0])return void(window.location.href="../../admin/login.php");var l=n[1],d=n[3].length,s="";if(l!=b)return;if(0==d)return void t("#crmwait_"+n[2]).html("No Data");s="";for(c=0;c<d;c++)s+="<tr>",0==c&&(s+='<td rowspan="'+d+'" style="vertical-align:middle">'+i+"</td>",s+='<td rowspan="'+d+'" style="vertical-align:middle">'+r+"</td>"),s+='<td style="border-left: 1px solid #dadada;">'+(c+1)+"</td>",s+="<td>("+n[3][c][0]+") "+n[3][c][1]+"</td>","yes"==n[3][c][2]?(s+='<td id="count_'+n[2]+"_"+n[3][c][0]+'"></td>',s+='<td id="status_'+n[2]+"_"+n[3][c][0]+'">'+_+"</td>"):(s+='<td id="count_'+n[2]+"_"+n[3][c][0]+'">0 / 0</td>',s+='<td id="status_'+n[2]+"_"+n[3][c][0]+'">'+p+"</td>"),s+='<td><button id="refcamp_'+n[2]+"_"+n[3][c][0]+'" type="button" class="btn btn-link btn-sm btn_refresh btn_refresh_campaign" id=""><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></td>',s+="</tr>";t("#tbody_"+n[2]).html(s);for(var c=0;c<d;c++)"yes"==n[3][c][2]&&o(n[2],n[3][c][0],"0")}},failure:function(t){a(!1),e("Cannot load campaign information.")}})}function o(n,i,o){t.ajax({type:"GET",url:"../daemon/ajax_admin/export_retention_affiliate.php",data:{user_token:b,crm_id:n,campaign_id:i,from_date:t("#from_date").val(),to_date:t("#to_date").val(),cycle:g,delete:o},success:function(a){var n=jQuery.parseJSON(a);if("error"==n[0])t("#status_"+n[2]).html(h),e("Cannot load retention information.");else{if("no_cookie"==n[0])return void(window.location.href="../../admin/login.php");var i=n[1],o=n[4].length;if(i!=b)return;if(t("#count_"+n[2]+"_"+n[3]).html("0 / "+o),0==o)return void t("#status_"+n[2]+"_"+n[3]).html(p);for(var l=0;l<o;l++)if("yes"==n[4][l][2])r(n[2],n[3],n[4][l][0],"0");else{var d=t("#count_"+n[2]+"_"+n[3]).html(),s=d.indexOf(" / "),c=parseInt(d.substr(0,s)),_=parseInt(d.substr(s+3));c++,t("#count_"+n[2]+"_"+n[3]).html(c+" / "+_),c==_&&t("#status_"+n[2]+"_"+n[3]).html(p)}}},failure:function(t){a(!1),e("Cannot load affiliate information.")}})}function r(n,i,o,r){t.ajax({type:"GET",url:"../daemon/ajax_admin/export_retention_subaffiliate.php",data:{user_token:b,crm_id:n,campaign_id:i,affiliate_id:o,from_date:t("#from_date").val(),to_date:t("#to_date").val(),cycle:g,delete:r},success:function(e){var a=jQuery.parseJSON(e);if("success"==a[0]){if(a[1]!=b)return;var n=t("#count_"+a[2]+"_"+a[3]).html(),i=n.indexOf(" / "),o=parseInt(n.substr(0,i)),r=parseInt(n.substr(i+3));o++,t("#count_"+a[2]+"_"+a[3]).html(o+" / "+r),o==r&&t("#status_"+a[2]+"_"+a[3]).html(p)}else if("no_cookie"==a[0])return void(window.location.href="../../admin/login.php")},failure:function(t){a(!1),e("Cannot load sub affiliate information.")}})}function l(){a(!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/setting_campaign_label_list.php",data:{},success:function(n){if(a(!1),"error"!=n)if("no_cookie"!=n){var i=jQuery.parseJSON(n),o="";if(i.length>0){for(var r=0;r<i.length;r++)o+="<tr>",o+="<td>"+(r+1)+"</td>",o+='<td id="label_'+i[r][0]+'">'+i[r][1]+"</td>",o+='<td><input type="checkbox" id="lblid_'+i[r][0]+'" class="label_item"></td>',o+="</tr>";t(".table_campaign_label_body").html(o),t("#campaign_label_modal").modal("toggle")}else e("There is no any campaign label list.")}else window.location.href="../../admin/login.php";else e("Cannot load campaign label list.")},failure:function(t){a(!1),e("Cannot load campaign label list.")}})}function d(){t("#from_date").prop("disabled",!0),t("#to_date").prop("disabled",!0);var e=new Date,a=s(e.getFullYear(),e.getMonth()+1,e.getDate());if("date_today"==f)u=a,m=a;else if("date_yesterday"==f)e.setDate(e.getDate()-1),u=s(e.getFullYear(),e.getMonth()+1,e.getDate()),m=s(e.getFullYear(),e.getMonth()+1,e.getDate());else if("date_thisweek"==f){n=e.getDate()+1;0==e.getDay()?n-=7:n-=e.getDay(),e.setDate(n),u=s(e.getFullYear(),e.getMonth()+1,e.getDate()),m=a}else if("date_thismonth"==f)u=s(e.getFullYear(),e.getMonth()+1,1),m=a;else if("date_thisyear"==f)u=s(e.getFullYear(),1,1),m=a;else if("date_lastweek"==f){var n=e.getDate()+1-7;0==e.getDay()?n-=7:n-=e.getDay(),e.setDate(n),u=s(e.getFullYear(),e.getMonth()+1,e.getDate()),n=e.getDate()+6,e.setDate(n),m=s(e.getFullYear(),e.getMonth()+1,e.getDate())}else"date_custom"==f&&(u="",m="",t("#from_date").prop("disabled",!1),t("#to_date").prop("disabled",!1));t("#from_date").val(u),t("#to_date").val(m)}function s(t,e,a){var n=a,i=e,o=t;return n<10&&(n="0"+n),i<10&&(i="0"+i),i+"/"+n+"/"+o}var c,_='<img src="../images/loading.gif" style="width:22px;height:22px;">',p='<span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span>',h='<span class="glyphicon glyphicon-remove-sign" aria-hidden="true" style="color: #ffa5a5"></span>',f="date_thisweek",u="",m="",g=1,b="";d(),n(),t("body").scrollspy({target:".bs-docs-sidebar",offset:0}),t(".input-daterange").datepicker({}),t(".date_dropdown_menu li").on("click",function(e){var a=t(this).text();f=t(this).find("a").attr("id"),t(".date_toggle_button").html(a+' <span class="caret"></span>'),d()}),t(".cycle_dropdown_menu li").on("click",function(e){g=t(this).text(),cycle_id=t(this).prop("id").substring(6),t(".cycle_toggle_button").html(g+' <span class="caret"></span>')}),t(".retention_search_button").click(function(){n()}),t(".export_content").on("click",".btn_refresh_crm",function(e){for(var a=t(this).prop("id").substring(7),n=0;n<c.length;n++)if(c[n][0]==a){var o;return o="<tr>",o+="<td>"+(n+1)+"</td>",o+="<td>"+c[n][1]+"</td>",o+='<td id="crmwait_'+a+'">'+_+"</td>",o+='<td colspan="4"></td>',o+="</tr>",t("#tbody_"+a).html(o),void i(a,n+1,c[n][1],"1")}}),t(".export_content").on("click",".btn_refresh_campaign",function(e){var a=t(this).prop("id").substring(8),n=a.indexOf("_"),i=parseInt(a.substr(0,n)),r=parseInt(a.substr(n+1));t("#count_"+i+"_"+r).html("0 / 0"),t("#status_"+i+"_"+r).html(_),o(i,r,"1")}),t(".btn_export").click(function(){t("#label_all").prop("checked",!1),t(".label_item").each(function(e){t(this).prop("checked",!1)}),l()}),t("#label_all").click(function(){t(".label_item").each(function(e){t("#label_all").prop("checked")?t(this).prop("checked",!0):t(this).prop("checked",!1)})}),t(".modal_btn_export").click(function(){var e="";t(".label_item").each(function(a){if(t(this).prop("checked")){""!=e&&(e+=" ");var n=t(this).prop("id").substring(6);e+=t("#label_"+n).html()}}),t("#campaign_label_modal").modal("toggle");var a="./export_excel_retention.php?type=retention&user_token="+b+"&from_date="+t("#from_date").val()+"&to_date="+t("#to_date").val()+"&campaign_labels="+e;window.location.href=a})});