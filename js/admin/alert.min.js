jQuery(document).ready(function(t){function e(e){"report"==type?(t(".level_alert").html(e),t(".level_alert").fadeIn(1e3,function(){t(".level_alert").fadeOut(3e3)})):"history"==type&&(t(".history_alert").html(e),t(".history_alert").fadeIn(1e3,function(){t(".history_alert").fadeOut(3e3)}))}function a(e,a){"report"==e?(j=a)?t(".alert_waiting").html(C):t(".alert_waiting").html(""):"history"==e&&((M=a)?t(".history_waiting").html(C):t(".history_waiting").html(""))}function n(){setInterval(function(){l(),_()},3e5)}function o(){t(".crm_dropdown_list").length>0&&(f=t(".crm_dropdown_list").prop("id"),m=t(".crm_dropdown_list").html())}function l(){j||(a("report",!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/crm_list.php",data:{},success:function(o){if(a("report",!1),"error"!=o)if("no_cookie"!=o){h=jQuery.parseJSON(o);var l="",i="";l+="<tr>",l+='<th rowspan="2" style="vertical-align:middle">#</th>',l+='<th rowspan="2" style="vertical-align:middle">Alert Name</th>',i+="<tr>";for(var d=0;d<h.length;d++)l+='<th colspan="2" style="width:100px; border-left: 1px solid #dadada">'+h[d][1]+"</th>",i+='<td style="border-left: 1px solid #dadada">Value</td>',i+="<td>Level</td>";l+='<th rowspan="2" style="border-left: 1px solid #dadada; vertical-align:middle"><button type="button" class="btn btn-link btn-sm btn_refresh_all" id=""><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></th>',l+="</tr>",i+="</tr>",t(".table_alert_head").html(l+i),r(),_(),n()}else window.location.href="../../admin/login.php";else e("report","Cannot load CRM list.")},failure:function(t){a("report",!1),e("report","Cannot load CRM list.")}}))}function r(){a("report",!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/setting_alert_type.php",data:{},success:function(n){if(a("report",!1),"error"!=n)if("no_cookie"!=n){g=jQuery.parseJSON(n);for(var o="",l=0;l<g.length;l++)if("1"==g[l][10]){o+="<tr><td>"+(l+1)+"</td>",o+='<td id="name_'+g[l][1]+'">'+g[l][2]+"</td>";for(var r=0;r<h.length;r++)o+='<td id="value_'+g[l][1]+"_"+h[r][0]+'" style="border-left: 1px solid #dadada"></td>',o+='<td id="level_'+g[l][1]+"_"+h[r][0]+'"></td>';o+='<td style="border-left: 1px solid #dadada"><button type="button" class="btn btn-link btn-sm btn_refresh" id="'+g[l][1]+'"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></td>',o+="</tr>"}t(".table_alert_body").html(o);for(l=0;l<g.length;l++)"1"==g[l][10]&&(i(g[l][1]),d(g[l][1]))}else window.location.href="../../admin/login.php";else e("report","Cannot load Alert Type list.")},failure:function(t){a("report",!1),e("report","Cannot load Alert Type list.")}})}function i(a){t.ajax({type:"GET",url:"../daemon/ajax_admin/setting_alert_list.php",data:{alert_type:a},success:function(a){var n=jQuery.parseJSON(a);if("error"!=n[0])if("no_cookie"!=n[0])for(var o=n[2].length,l=0;l<o;l++)t("#level_"+n[2][l][2]+"_"+n[2][l][1]).html(n[2][l][4]);else window.location.href="../../admin/login.php";else e("report","Cannot load alert level information.")},failure:function(t){e("report","Cannot load alert level information.")}})}function d(a){t.ajax({type:"GET",url:"../daemon/ajax_admin/alert_report_list.php",data:{alert_type:a,date:u()},success:function(a){var n=jQuery.parseJSON(a);if("error"!=n[0])if("no_cookie"!=n[0])for(var o=n[2],l=0;l<o.length;l++){var r=o[l][3],i=t("#level_"+o[l][2]+"_"+o[l][1]).html();"1"==o[l][5]?(t("#value_"+o[l][2]+"_"+o[l][1]).html('<span class="payment_badge payment_badge_red">'+r+"</span>"),t("#level_"+o[l][2]+"_"+o[l][1]).html('<span class="payment_badge payment_badge_blue">'+i+"</span>")):t("#value_"+o[l][2]+"_"+o[l][1]).html(r)}else window.location.href="../../admin/login.php";else e("report","Cannot load alert level information.")},failure:function(t){e("report","Cannot load alert level information.")}})}function s(){t("#from_date").prop("disabled",!0),t("#to_date").prop("disabled",!0);var e=new Date,a=p(e.getFullYear(),e.getMonth()+1,e.getDate());if("date_today"==y)b=a,v=a;else if("date_yesterday"==y)e.setDate(e.getDate()-1),b=p(e.getFullYear(),e.getMonth()+1,e.getDate()),v=p(e.getFullYear(),e.getMonth()+1,e.getDate());else if("date_thisweek"==y){n=e.getDate()+1;0==e.getDay()?n-=7:n-=e.getDay(),e.setDate(n),b=p(e.getFullYear(),e.getMonth()+1,e.getDate()),v=a}else if("date_thismonth"==y)b=p(e.getFullYear(),e.getMonth()+1,1),v=a;else if("date_thisyear"==y)b=p(e.getFullYear(),1,1),v=a;else if("date_lastweek"==y){var n=e.getDate()+1-7;0==e.getDay()?n-=7:n-=e.getDay(),e.setDate(n),b=p(e.getFullYear(),e.getMonth()+1,e.getDate()),n=e.getDate()+6,e.setDate(n),v=p(e.getFullYear(),e.getMonth()+1,e.getDate())}else"date_custom"==y&&(b="",v="",t("#from_date").prop("disabled",!1),t("#to_date").prop("disabled",!1));t("#from_date").val(b),t("#to_date").val(v)}function p(t,e,a){var n=a,o=e,l=t;return n<10&&(n="0"+n),o<10&&(o="0"+o),o+"/"+n+"/"+l}function c(){var e="",a="";if(k>0){var n=Math.floor((w-1)/D),o=n*D+1,l=(n+1)*D;l*x>k&&(l=Math.floor(k/x),k%x>0&&l++);for(var r=o;r<=l;r++)e+=r==w?'<button type="button" class="btn btn-success btn-sm campaign_page" id="page_'+r+'">'+r+"</button>":'<button type="button" class="btn btn-default btn-sm campaign_page" id="page_'+r+'">'+r+"</button>";n>0&&(a+='<button type="button" class="btn btn-default btn-sm campaign_page" id="page_first">&lt;&lt;</button><button type="button" class="btn btn-default btn-sm campaign_page" id="page_prev">&lt;</button>'),a+=e,l*x<k&&(a+='<button type="button" class="btn btn-default btn-sm campaign_page" id="page_next">&gt;</button><button type="button" class="btn btn-default btn-sm campaign_page" id="page_last">&gt;&gt;</button>')}t(".campaign_pagination").html(a)}function _(){""!=t("#from_date").val()?""!=t("#to_date").val()?(a("history",!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/alert_history_list.php",data:{crm_id:f,from_date:t("#from_date").val(),to_date:t("#to_date").val(),page_number:w,items_page:x},success:function(n){a("history",!1);var o=jQuery.parseJSON(n);if("error"==o[0])e("history","Cannot load alert history.");else{if("no_cookie"==o[0])return void(window.location.href="../../admin/login.php");k=o[2].length;for(var l=o[2].data,r="",i=0;i<l.length;i++)r+="<tr>",r+="<td>"+((w-1)*x+i+1)+"</td>",r+="<td>"+l[i][12]+"</td>",r+="<td>"+l[i][11]+"</td>",r+="<td>"+l[i][6]+"</td>",r+="<td>"+l[i][9]+"</td>",r+="<td>"+l[i][10]+"</td>","1"==l[i][7]?r+="<td>"+F+"</td>":r+="<td></td>","1"==l[i][8]?r+="<td>"+T+"</td>":r+="<td></td>",r+="</tr>";t(".table_history_body").html(r),c()}},failure:function(t){a("history",!1),e("history","Cannot load alert history")}})):e("history","Please select TO DATE."):e("history","Please select FROM DATE.")}function u(){var t=new Date,e=t.getMonth()+1,a=t.getDate();return e<10&&(e="0"+e),a<10&&(a="0"+a),t.getFullYear()+"-"+e+"-"+a}var h,g,f=-1,m="",y="date_thisweek",b="",v="",w=1,x=10,D=7,k=0,j=!1,M=!1,C='<img src="../images/loading.gif" style="width:22px;height:22px;">',F='<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>',T='<span class="glyphicon glyphicon-remove" aria-hidden="true" style="color: #ffa5a5"></span>';o(),s(),l(),t(".table_alert_head").on("click",".btn_refresh_all",function(t){l()}),t(".table_alert_body").on("click",".btn_refresh",function(e){var a=t(this).prop("id");i(a),d(a)}),t(".crm_dropdown_menu li").on("click",function(e){m=t(this).text(),f=t(this).find("a").attr("id"),t(".crm_toggle_button").html(m+' <span class="caret"></span>')}),t(".input-daterange").datepicker({}),t(".date_dropdown_menu li").on("click",function(e){var a=t(this).text();y=t(this).find("a").attr("id"),t(".date_toggle_button").html(a+' <span class="caret"></span>'),s()}),t(".cycle_dropdown_menu li").on("click",function(e){cycle=t(this).text(),cycle_id=t(this).prop("id").substring(6),t(".cycle_toggle_button").html(cycle+' <span class="caret"></span>')}),t(".history_search_button").click(function(){_()}),t(".count_dropdown_menu li").on("click",function(e){x=t(this).text(),t(".count_toggle_button").html(x+' <span class="caret"></span>'),w=1,_()}),t(".campaign_pagination").on("click",".campaign_page",function(e){var a=t(this).prop("id").substring(5),n=Math.floor((w-1)/D);"first"==a?w=1:"prev"==a?w=(n-1)*D+1:"next"==a?w=(n+1)*D+1:"last"==a?(w=Math.floor(k/x),k%x>0&&w++):w=a,_()})});