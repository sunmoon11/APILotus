jQuery(document).ready(function(t){function a(a,i){"affiliate"==a?(t(".dashboard_affiliate_alert").html(i),t(".dashboard_affiliate_alert").fadeIn(1e3,function(){t(".dashboard_affiliate_alert").fadeOut(3e3)})):"setting"==a&&(t(".setting_edit_alert").html(i),t(".setting_edit_alert").fadeIn(1e3,function(){t(".setting_edit_alert").fadeOut(3e3)}))}function i(a,i,e){"affiliate"==a?e?t(".dashboard_affiliate_waiting").html(h):t(".dashboard_affiliate_waiting").html(""):"crm"==a&&(e?(t("#acount_"+i).html(""),t("#astate_"+i).html(h)):t("#astate_"+i).html(""))}function e(a){t(".affiliate_sub_item").each(function(i){t(this).prop("id")=="aitemid_"+a&&t(this).remove()}),t("#asubid_"+a).remove()}function d(){"date_today"!=F?"date_yesterday"!=F?"date_thisweek"!=F?(i("affiliate","",!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/crm_list.php",data:{},success:function(e){if(i("affiliate","",!1),"error"!=e)if("no_cookie"!=e){var d=(v=jQuery.parseJSON(e)).length,l="";if(d>0){for(o=0;o<d;o++)l+="<tr><td>"+(o+1)+"</td>",l+="<td>"+v[o][1]+"</td>",l+='<td id="acount_'+v[o][0]+'"></td>',l+='<td id="astate_'+v[o][0]+'"></td>',l+='<td><button type="button" id="arefresh_'+v[o][0]+'" class="btn btn-link btn-sm btn_refresh"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></td>',l+="</tr>";t(".table_affiliate_state_body").html(l);for(var o=0;o<d;o++)0==o?n(v[o][0],"1"):n(v[o][0],"0")}else a("affiliate","There is no any crm site information.")}else window.location.href="../../admin/login.php";else a("affiliate","Cannot load CRM site information.")},failure:function(t){i("affiliate","",!1),a("affiliate","Cannot load CRM site information.")}})):l(2):l(1):l(0)}function n(e,d){""!=t("#from_date").val()?""!=t("#to_date").val()?"date_today"!=F&&"date_yesterday"!=F&&"date_thisweek"!=F&&(i("crm",e,!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_list.php",data:{user_token:w,crm_id:e,from_date:t("#from_date").val(),to_date:t("#to_date").val(),delete:d},success:function(i){var e=jQuery.parseJSON(i);if("error"==e[0])a("affiliate","Cannot load affiliate information."),t("#astate_"+e[1]).html(g);else{if("no_cookie"==e[0])return void(window.location.href="../../admin/login.php");if(t("#acount_"+e[1]).html("0 / "+e[2].length),"0"==e[2].length)return void t("#astate_"+e[1]).html(m);for(var d=0;d<e[2].length;d++)t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_cid.php",data:{user_token:w,crm_id:e[1],campaign_id:e[2][d].campaign_id,from_date:t("#from_date").val(),to_date:t("#to_date").val()},success:function(a){var i=jQuery.parseJSON(a);if("success"==i[0]){var e=t("#acount_"+i[1]).html(),d=e.indexOf(" / "),n=parseInt(e.substr(0,d)),l=parseInt(e.substr(d+3));n++,t("#acount_"+i[1]).html(n+" / "+l),n==l&&(t("#astate_"+i[1]).html(m),o())}else if("no_cookie"==i[0])return void(window.location.href="../../admin/login.php")},failure:function(t){a("affiliate","Cannot load affiliate information.")}})}},failure:function(t){a("affiliate","Cannot load affiliate information.")}})):a("affiliate","Please select TO DATE."):a("affiliate","Please select FROM DATE.")}function l(e){i("affiliate","",!0),t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_cache.php",data:{date_type:e},success:function(e){i("affiliate","",!1);var d=jQuery.parseJSON(e);if("error"==d[0])a("affiliate","Cannot load affiliate information.");else{if("no_cookie"==d[0])return void(window.location.href="../../admin/login.php");for(var n="",l=0;l<d[0].length;l++)n+="<tr><td>"+(l+1)+"</td>",n+="<td>"+d[0][l][1]+"</td>",n+='<td id="acount_'+d[0][l][0]+'">'+d[0][l][2]+" / "+d[0][l][2]+"</td>",n+='<td id="astate_'+d[0][l][0]+'">'+m+"</td>",n+='<td><button type="button" id="arefresh_'+d[0][l][0]+'" class="btn btn-link btn-sm btn_refresh" disabled="disabled"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button></td>',n+="</tr>";t(".table_affiliate_state_body").html(n),n="";for(l=0;l<d[1].length;l++){var o=parseFloat(d[1][l][1]),s=parseFloat(d[1][l][2]),f=parseFloat(d[1][l][3]),r=parseFloat(d[1][l][4]);n+='<tr id="asumid_'+d[1][l][0]+'">',n+='<td><button type="button" class="btn btn-link btn-sm btn_sub_expand" id="aid_'+d[1][l][0]+'">'+b+"</button></td>",n+='<td id="aname_'+d[1][l][0]+'">('+d[1][l][0]+") "+d[1][l][5]+"</td>",n+="<td>"+o+"</td>",n+="<td>"+s+"</td>",n+=0!=o?"<td>"+(100*s/o).toFixed(2)+"</td>":"<td>0</td>",n+="<td>"+f+"</td>",n+=f+r!=0?"<td>"+(100*f/(f+r)).toFixed(2)+"</td>":"<td>0</td>",n+="<td></td>",n+="<td></td>",n+='<td><button type="button" id="setting_'+d[1][l][0]+'" class="btn btn-link btn-sm btn_setting" data-toggle="modal" data-target="#setting_edit_modal"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></button></td>',n+="</tr>"}t(".table_affiliate_data_body").html(n)}},failure:function(t){i("affiliate","",!1),a("affiliate","Cannot load affiliate information.")}})}function o(){t(".btn_sub_expand").each(function(a){affiliate_id=t(this).prop("id").substring(4),e(affiliate_id),t("#aid_"+affiliate_id).html(b)}),t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_sum.php",data:{user_token:w},success:function(i){if("error"!=i)if("no_cookie"!=i){for(var e=jQuery.parseJSON(i),d="",n=0;n<e.length;n++){var l=parseFloat(e[n][1]),o=parseFloat(e[n][2]),s=parseFloat(e[n][3]),f=parseFloat(e[n][4]);d+='<tr id="asumid_'+e[n][0]+'">',d+='<td><button type="button" class="btn btn-link btn-sm btn_sub_expand" id="aid_'+e[n][0]+'">'+b+"</button></td>",d+='<td id="aname_'+e[n][0]+'">('+e[n][0]+") "+e[n][5]+"</td>",d+="<td>"+l+"</td>",d+="<td>"+o+"</td>",d+=0!=l?"<td>"+(100*o/l).toFixed(2)+"</td>":"<td>0</td>",d+="<td>"+s+"</td>",d+=s+f!=0?"<td>"+(100*s/(s+f)).toFixed(2)+"</td>":"<td>0</td>",d+="<td></td>",d+="<td></td>",d+='<td><button type="button" id="setting_'+e[n][0]+'" class="btn btn-link btn-sm btn_setting" data-toggle="modal" data-target="#setting_edit_modal"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></button></td>',d+="</tr>"}t(".table_affiliate_data_body").html(d)}else window.location.href="../../admin/login.php";else a("affiliate","Cannot load affiliate sum information.")},failure:function(t){a("affiliate","Cannot load affiliate sum information.")}})}function s(i){"date_today"!=F?"date_yesterday"!=F?"date_thisweek"!=F?(p=!0,t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_sub.php",data:{affiliate_id:i,user_token:w},success:function(a){p=!1;var i=jQuery.parseJSON(a),e="";if("error"!=i[0])if("no_cookie"!=i[0]){for(var d=0;d<i[2].length;d++){var n=parseFloat(i[2][d][1]),l=parseFloat(i[2][d][2]),o=parseFloat(i[2][d][3]),s=parseFloat(i[2][d][4]),f=parseFloat(i[2][d][6]);if(e='<tr id="aitemid_'+i[1]+'" class="affiliate_sub_item">',e+='<td style="border-top:none"></td>',e+="<td>"+i[2][d][5]+"</td>",e+='<td id="astep1_'+i[1]+"_"+i[2][d][0]+'">'+n+"</td>",e+="<td>"+l+"</td>",e+=0!=n?"<td>"+(100*l/n).toFixed(2)+"</td>":"<td>0</td>",e+="<td>"+o+"</td>",e+=o+s!=0?"<td>"+(100*o/(o+s)).toFixed(2)+"</td>":"<td>0</td>",f>0){var r=100*n/f;e+='<td id="agoap_'+i[1]+"_"+i[2][d][0]+'">'+r.toFixed(2)+"</td>"}else e+='<td id="agoap_'+i[1]+"_"+i[2][d][0]+'">0</td>';e+='<td id="agoal_'+i[1]+"_"+i[2][d][0]+'">'+f+"</td>",e+="<td></td>",e+="</tr>",t("#asumid_"+i[1]).closest("tr").after(e)}0==i[2].length?t("#awaitid_"+i[1]).html("There is no any affiliate data."):t("#awaitid_"+i[1]).html(m)}else window.location.href="../../admin/login.php";else t("#awaitid_"+i[1]).html(g)},failure:function(t){p=!1,a("affiliate","Cannot load affiliate sub information.")}})):f(i,2):f(i,1):f(i,0)}function f(i,e){p=!0,t.ajax({type:"GET",url:"../daemon/ajax_admin/dashboard_affiliate_cache_sub.php",data:{date_type:e,affiliate_id:i},success:function(a){p=!1;var i=jQuery.parseJSON(a),e="";if("error"!=i[0])if("no_cookie"!=i[0]){for(var d=0;d<i[2].length;d++){var n=parseFloat(i[2][d][1]),l=parseFloat(i[2][d][2]),o=parseFloat(i[2][d][3]),s=parseFloat(i[2][d][4]),f=parseFloat(i[2][d][6]);if(e='<tr id="aitemid_'+i[1]+'" class="affiliate_sub_item">',e+='<td style="border-top:none"></td>',e+="<td>"+i[2][d][5]+"</td>",e+='<td id="astep1_'+i[1]+"_"+i[2][d][0]+'">'+n+"</td>",e+="<td>"+l+"</td>",e+=0!=n?"<td>"+(100*l/n).toFixed(2)+"</td>":"<td>0</td>",e+="<td>"+o+"</td>",e+=o+s!=0?"<td>"+(100*o/(o+s)).toFixed(2)+"</td>":"<td>0</td>",f>0){var r=100*n/f;e+='<td id="agoap_'+i[1]+"_"+i[2][d][0]+'">'+r.toFixed(2)+"</td>"}else e+='<td id="agoap_'+i[1]+"_"+i[2][d][0]+'">0</td>';e+='<td id="agoal_'+i[1]+"_"+i[2][d][0]+'">'+f+"</td>",e+="<td></td>",e+="</tr>",t("#asumid_"+i[1]).closest("tr").after(e)}0==i[2].length?t("#awaitid_"+i[1]).html("There is no any affiliate data."):t("#awaitid_"+i[1]).html(m)}else window.location.href="../../admin/login.php";else t("#awaitid_"+i[1]).html(g)},failure:function(t){p=!1,a("affiliate","Cannot load affiliate sub information.")}})}function r(i){t.ajax({type:"GET",url:"../daemon/ajax_admin/affiliate_list.php",data:{affiliate_id:i},success:function(i){var e=jQuery.parseJSON(i);if("error"!=e[0])if("no_cookie"!=e[0]){var d="";d+='<div class="alert alert-warning setting_edit_alert" role="alert" style="display:none"></div>',d+='<div class="row" style="margin-bottom:5px;">',d+='<div class="col-xs-6 modal_input_label">Affiliate ID</div>',d+='<div class="col-xs-6"><input type="text" class="form-control input-sm edit_aff_id" value="'+e[1]+'" readonly="readonly"></div>',d+="</div>",d+='<div class="row" style="margin-bottom:5px;">',d+='<div class="col-xs-6 modal_input_label">Affiliate Label</div>',d+='<div class="col-xs-6"><input type="text" class="form-control input-sm edit_aff_label" value="'+e[2].label+'"></div>',d+="</div>";for(var n=0;n<e[2].goals.length;n++){var l=0;""!=e[2].goals[n][2]&&(l=e[2].goals[n][2]),d+='<div class="row" style="margin-bottom:5px;">',d+='<div class="col-xs-6 modal_input_label">'+e[2].goals[n][1]+" Goal</div>",d+='<div class="col-xs-6"><input type="text" id="cgoal_'+e[2].goals[n][0]+'" class="form-control input-sm aff_crm_goal" value="'+l+'"></div>',d+="</div>"}t(".modal_setting_alert_body").html(d)}else window.location.href="../../admin/login.php";else a("setting","Cannot load affiliate goal information.")},failure:function(t){a("setting","Cannot load affiliate goal information.")}})}function _(i,e,d,n){t.ajax({type:"GET",url:"../daemon/ajax_admin/setting_affiliate_edit.php",data:{affiliate_id:i,affiliate_label:e,crm_ids:d,goals:n},success:function(t){if("error"==t)a("main","Affiliate settings cannot be changed.");else if("no_cookie"==t)return void(window.location.href="../../admin/login.php")},failure:function(t){a("main","Affiliate settings cannot be changed.")}})}function c(){t("#from_date").prop("disabled",!0),t("#to_date").prop("disabled",!0);var a=new Date,i=u(a.getFullYear(),a.getMonth()+1,a.getDate());if("date_today"==F)k=i,j=i;else if("date_yesterday"==F)a.setDate(a.getDate()-1),k=u(a.getFullYear(),a.getMonth()+1,a.getDate()),j=u(a.getFullYear(),a.getMonth()+1,a.getDate());else if("date_thisweek"==F){e=a.getDate()+1;0==a.getDay()?e-=7:e-=a.getDay(),a.setDate(e),k=u(a.getFullYear(),a.getMonth()+1,a.getDate()),j=i}else if("date_thismonth"==F)k=u(a.getFullYear(),a.getMonth()+1,1),j=i;else if("date_thisyear"==F)k=u(a.getFullYear(),1,1),j=i;else if("date_lastweek"==F){var e=a.getDate()+1-7;0==a.getDay()?e-=7:e-=a.getDay(),a.setDate(e),k=u(a.getFullYear(),a.getMonth()+1,a.getDate()),e=a.getDate()+6,a.setDate(e),j=u(a.getFullYear(),a.getMonth()+1,a.getDate())}else"date_custom"==F&&(k="",j="",t("#from_date").prop("disabled",!1),t("#to_date").prop("disabled",!1));t("#from_date").val(k),t("#to_date").val(j)}function u(t,a,i){var e=i,d=a,n=t;return e<10&&(e="0"+e),d<10&&(d="0"+d),d+"/"+e+"/"+n}var p=!1,h='<img src="../images/loading.gif" style="width:22px;height:22px;">',m='<span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span>',g='<span class="glyphicon glyphicon-remove-sign" aria-hidden="true" style="color: #ffa5a5"></span>',b='<span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>',y='<span class="glyphicon glyphicon-minus-sign" aria-hidden="true" style="color: #ffa5a5"></span>',v=new Array,x=-1,w="",F="date_thisweek",k="",j="";w=Math.floor(10*Math.random()+1),c(),d(),t(".input-daterange").datepicker({}),t(".date_dropdown_menu li").on("click",function(a){var i=t(this).text();F=t(this).find("a").attr("id"),t(".date_toggle_button").html(i+' <span class="caret"></span>'),c()}),t(".affiliate_search_button").click(function(){d()}),t(".btn_refresh_all").click(function(){d()}),t(".table_affiliate_state_body").on("click",".btn_refresh",function(a){n(t(this).prop("id").substring(9),"0")}),t(".btn_expand_all").click(function(){if(!p){var a="",i=-1!=t(this).html().indexOf("glyphicon-plus-sign");t(".btn_sub_expand").each(function(d){affiliate_id=t(this).prop("id").substring(4),e(affiliate_id),i?(t("#aid_"+affiliate_id).html(y),a='<tr id="asubid_'+affiliate_id+'" class="affiliate_sub_item">',a+='<td style="border-top:none"></td>',a+='<td id="awaitid_'+affiliate_id+'">'+h+"</td>",a+='<td colspan="8"></td>',a+="</tr>",t(this).closest("tr").after(a),s(affiliate_id)):t("#aid_"+affiliate_id).html(b)}),i?t(this).html(y):t(this).html(b)}}),t(".table_affiliate_data_body").on("click",".btn_sub_expand",function(a){if(!p){var i="",d=-1!=t(this).html().indexOf("glyphicon-plus-sign");affiliate_id=t(this).prop("id").substring(4),e(affiliate_id),d?(t(this).html(y),i='<tr id="asubid_'+affiliate_id+'" class="affiliate_sub_item">',i+='<td style="border-top:none"></td>',i+='<td id="awaitid_'+affiliate_id+'">'+h+"</td>",i+='<td colspan="8"></td>',i+="</tr>",t(this).closest("tr").after(i),s(affiliate_id)):t(this).html(b)}}),t(".table_affiliate_data_body").on("click",".btn_setting",function(a){r(x=t(this).prop("id").substring(8))}),t(".modal_btn_setting_edit").click(function(){if(""==t(".edit_aff_label").val())return a("setting","Please input Affiliate Label."),void t(".edit_aff_label").focus();t(".aff_crm_goal").each(function(i){if(""==t(this).val())return a("setting","Please input CRM Goal."),void t(this).focus()});var i="",e="";t(".aff_crm_goal").each(function(a){""!=i&&(i+=","),""!=e&&(e+=","),i+=t(this).prop("id").substring(6),""==t(this).val()?e+="0":e+=t(this).val()}),t("#setting_edit_modal").modal("toggle"),_(t(".edit_aff_id").val(),t(".edit_aff_label").val(),i,e),t("#aname_"+t(".edit_aff_id").val()).html("("+t(".edit_aff_id").val()+") "+t(".edit_aff_label").val()),t(".aff_crm_goal").each(function(a){var i=t(this).prop("id").substring(6),e=parseInt(t(this).val()),d=parseInt(t("#astep1_"+t(".edit_aff_id").val()+"_"+i).html()),n=0;e>0&&(n=(100*d/e).toFixed(2)),t("#agoap_"+t(".edit_aff_id").val()+"_"+i).html(n),t("#agoal_"+t(".edit_aff_id").val()+"_"+i).html(e)})})});