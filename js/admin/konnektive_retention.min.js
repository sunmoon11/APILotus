jQuery(document).ready(function(t){function e(){t(".crm_dropdown_list").length>0&&(g=t(".crm_dropdown_list").prop("id"))}function a(e){t(".retention_report_alert").html(e),t(".retention_report_alert").fadeIn(1e3,function(){t(".retention_report_alert").fadeOut(3e3)})}function d(e){t(".retention_report_waiting").html(e?_:"")}function o(){""!=t("#from_date").val()?""!=t("#to_date").val()?(d(!0),t.ajax({type:"POST",url:"../daemon/ajax_admin/konnektive/retention_report.php",data:{crm_id:g,from_date:t("#from_date").val(),to_date:t("#to_date").val(),cycle:b,campaign_ids:h(x),campaign_names:s(x),product_id:k,affiliate_id:$},success:function(e){d(!1);var o=jQuery.parseJSON(e);if(t(".table_retention_report_body").html(""),"success"==o[0]){if("error"==o[2]||"No results found."==o[2])return void a(o[2]);var i="",r="---",n=o[2].report;if(0==(w=o[2].cycle))return void a("No results found.");i="<tr>",i+='<th rowspan="2"></th>',i+='<th rowspan="2" style="vertical-align:middle;">Campaign Name</th>',i+='<th colspan="10" style="border: 1px solid #dadada">Initial Cycle</th>';for(l=1;l<w;l++)i+='<th colspan="15" style="border: 1px solid #dadada">Cycle '+(l+1)+"</th>";i+='<th colspan="3" style="border: 1px solid #dadada">Totals</th>',i+="</tr>",i+="<tr>",i+='<th style="border-left: 1px solid #dadada">Orders</th>',i+="<th>CPA</th>",i+="<th>Cancels</th>",i+="<th>Chargebacks</th>",i+="<th>Gross</th>",i+="<th>Partial Refund</th>",i+="<th>Full Refund</th>",i+="<th>Expenses</th>",i+="<th>Commission</th>",i+="<th>Net</th>";for(l=1;l<w;l++)i+='<th style="border-left: 1px solid #dadada">Approvals</th>',i+="<th>Soft Declines</th>",i+="<th>Hard Declines</th>",i+="<th>Approve %</th>",i+="<th>Partial Refund</th>",i+="<th>Full Refund</th>",i+="<th>Cancels</th>",i+="<th>Chargebacks</th>",i+="<th>Recycle Save</th>",i+="<th>Pending</th>",i+="<th>Retention</th>",i+="<th>Gross</th>",i+="<th>Expenses</th>",i+="<th>Commission</th>",i+="<th>Net</th>";i+='<th style="border-left: 1px solid #dadada">AVG LTV</th>',i+="<th>Gross</th>",i+="<th>Net</th>",i+="</tr>",t(".table_retention_report_head").html(i),i="";for(var l=0;l<n.length;l++){i+="<tr>",i+="<td></td>",i+='<td style="min-width:350px;!important">'+n[l][1]+"</td>",i+='<td style="border-left: 1px solid #dadada">'+n[l][2]+"</td>",i+="<td>"+(n[l][3]!=r?"$":"")+n[l][3]+"</td>",i+="<td>"+n[l][4]+"</td>",i+="<td>"+n[l][5]+"</td>",i+="<td>"+(n[l][6]!=r?"$":"")+n[l][6]+"</td>",i+="<td>"+(n[l][7]!=r?"$":"")+n[l][7]+"</td>",i+="<td>"+(n[l][8]!=r?"$":"")+n[l][8]+"</td>",i+="<td>"+(n[l][9]!=r?"$":"")+n[l][9]+"</td>",i+="<td>"+(n[l][10]!=r?"$":"")+n[l][10]+"</td>",i+="<td>"+(n[l][11]!=r?"$":"")+n[l][11]+"</td>";for(var h=1;h<w;h++){s=11+15*(h-1);i+='<td style="border-left: 1px solid #dadada">'+n[l][s+1]+"</td>",i+="<td>"+n[l][s+2]+"</td>",i+="<td>"+n[l][s+3]+"</td>",i+="<td>"+n[l][s+4]+(n[l][s+4]!=r?"%":"")+"</td>",i+="<td>"+(n[l][s+5]!=r?"$":"")+n[l][s+5]+"</td>",i+="<td>"+(n[l][s+6]!=r?"$":"")+n[l][s+6]+"</td>",i+="<td>"+n[l][s+7]+"</td>",i+="<td>"+n[l][s+8]+"</td>",i+="<td>"+n[l][s+9]+"</td>",i+="<td>"+n[l][s+10]+"</td>",i+="<td>"+n[l][s+11]+(n[l][s+11]!=r?"%":"")+"</td>",i+="<td>"+(n[l][s+12]!=r?"$":"")+n[l][s+12]+"</td>",i+="<td>"+(n[l][s+13]!=r?"$":"")+n[l][s+13]+"</td>",i+="<td>"+(n[l][s+14]!=r?"$":"")+n[l][s+14]+"</td>",i+="<td>"+(n[l][s+15]!=r?"$":"")+n[l][s+15]+"</td>"}var s=11+15*(w-1);i+='<td style="border-left: 1px solid #dadada">'+(n[l][s+1]!=r?"$":"")+n[l][s+1]+"</td>",i+="<td>"+(n[l][s+2]!=r?"$":"")+n[l][s+2]+"</td>",i+="<td>"+(n[l][s+3]!=r?"$":"")+n[l][s+3]+"</td>",i+="</tr>"}t(".table_retention_report_body").html(i)}else if("no_cookie"==o[0])return void(window.location.href="../../admin/login.php")},failure:function(t){d(!1),a("Cannot load retention.")}})):a("Please select TO DATE."):a("Please select FROM DATE.")}function i(){t("#from_date").prop("disabled",!0),t("#to_date").prop("disabled",!0);var e=new Date,a=r(e.getFullYear(),e.getMonth()+1,e.getDate());if("date_today"==m)y=a,v=a;else if("date_yesterday"==m)e.setDate(e.getDate()-1),y=r(e.getFullYear(),e.getMonth()+1,e.getDate()),v=r(e.getFullYear(),e.getMonth()+1,e.getDate());else if("date_thisweek"==m){d=e.getDate()+1;0==e.getDay()?d-=7:d-=e.getDay(),e.setDate(d),y=r(e.getFullYear(),e.getMonth()+1,e.getDate()),v=a}else if("date_thismonth"==m)y=r(e.getFullYear(),e.getMonth()+1,1),v=a;else if("date_thisyear"==m)y=r(e.getFullYear(),1,1),v=a;else if("date_lastweek"==m){var d=e.getDate()+1-7;0==e.getDay()?d-=7:d-=e.getDay(),e.setDate(d),y=r(e.getFullYear(),e.getMonth()+1,e.getDate()),d=e.getDate()+6,e.setDate(d),v=r(e.getFullYear(),e.getMonth()+1,e.getDate())}else"date_custom"==m&&(y="",v="",t("#from_date").prop("disabled",!1),t("#to_date").prop("disabled",!1));t("#from_date").val(y),t("#to_date").val(v)}function r(t,e,a){var d=a,o=e,i=t;return d<10&&(d="0"+d),o<10&&(o="0"+o),o+"/"+d+"/"+i}function n(){x=0,t(".category_toggle_button").html("All Categories"+F),t.ajax({type:"GET",url:"../daemon/ajax_admin/konnektive/campaign_category_list.php",data:{crm_id:g},success:function(e){var a='<li><a href="#" id="0">All Campaigns</a></li>';if("error"==e)return x=0,void t(".category_dropdown_menu").html(a);if("no_cookie"!=e){c=jQuery.parseJSON(e);for(var d=0;d<c.length;d++)a+='<li><a href="#" id="'+c[d][0]+'">'+c[d][1]+"</a></li>";t(".category_dropdown_menu").html(a)}else window.location.href="../../admin/login.php"},failure:function(t){a("main","Cannot load campaign category list.")}})}function l(){k=0,$=0,t(".product_toggle_button").html("All Products"+F),t(".affiliate_toggle_button").html("All Affiliates"+F),t(".product_dropdown_menu").html('<li><a href="#" id="0">All Products</a></li>'),t(".affiliate_dropdown_menu").html('<li><a href="#" id="0">All Affiliates</a></li>'),t.ajax({type:"GET",url:"../daemon/ajax_admin/konnektive/product_affiliate_list.php",data:{crm_id:g},success:function(e){var a=jQuery.parseJSON(e);if("no_cookie"!=a[0]){if("success"==a[0]){var d='<li><a href="#" id="0">All Products</a></li>';f=a[2];for(o=0;o<f.length;o++)d+='<li><a href="#" id="'+f[o][0]+'">'+f[o][1]+"</a></li>";t(".product_dropdown_menu").html(d),d='<li><a href="#" id="0">All Affiliates</a></li>',u=a[3];for(var o=0;o<u.length;o++)d+='<li><a href="#" id="'+u[o][0]+'">'+u[o][1]+"</a></li>";t(".affiliate_dropdown_menu").html(d)}}else window.location.href="../../admin/login.php"},failure:function(t){a("main","Cannot load product & affiliate list.")}})}function h(t){try{for(var e=0;e<c.length;e++)if(t==c[e][0])return c[e][2]}catch(t){return""}return""}function s(t){try{for(var e=0;e<c.length;e++)if(t==c[e][0])return c[e][3]}catch(t){return""}return""}var c,f,u,_='<img src="../images/loading.gif" style="width:22px;height:22px;">',p="",g=-1,m="date_thisweek",y="",v="",b=1,w=1,x=0,D="",k=0,A="",$=0,C="",F=' <span class="caret"></span>';i(),e(),n(),l(),o(),t(".input-daterange").datepicker({}),t(".date_dropdown_menu li").on("click",function(e){var a=t(this).text();m=t(this).find("a").attr("id"),t(".date_toggle_button").html(a+' <span class="caret"></span>'),i()}),t(".crm_dropdown_menu").on("click","li",function(e){p=t(this).text(),g=t(this).find("a").attr("id"),t(".crm_toggle_button").html(p+F),n(),l()}),t(".cycle_dropdown_menu li").on("click",function(e){b=t(this).text(),cycle_id=t(this).prop("id").substring(6),t(".cycle_toggle_button").html(b+' <span class="caret"></span>')}),t(".category_dropdown_menu").on("click","li",function(e){D=t(this).text(),x=t(this).find("a").attr("id"),t(".category_toggle_button").html(D+F)}),t(".product_dropdown_menu").on("click","li",function(e){A=t(this).text(),k=t(this).find("a").attr("id"),t(".product_toggle_button").html(A+F)}),t(".affiliate_dropdown_menu").on("click","li",function(e){C=t(this).text(),$=t(this).find("a").attr("id"),t(".affiliate_toggle_button").html(C+F)}),t(".retention_search_button").click(function(){o()})});